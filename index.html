<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>OCR Camera</title>
  <meta name="theme-color" content="#0b1020" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="OCR Camera" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <link rel="icon" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" sizes="512x512" href="icons/icon-512.png" />
  <style>
    :root { --bg:#0b1020; --panel:#121a33; --muted:#9aa4b2; --text:#e8ecf3; --accent:#6ee7ff; --green:#28e0b9; --yellow:#ffd766; --red:#ff7a7a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--text)}
    header{padding:24px 16px 10px;text-align:center}
    h1{margin:0 0 8px;font-size:24px}
    .sub{color:var(--muted);font-size:14px}
    .safety{max-width:900px;margin:10px auto 0;background:#0e2238;border:1px solid #1c3a5c;color:#a8e7ff;padding:10px 14px;border-radius:12px;font-size:14px}
    .wrap{max-width:980px;margin:18px auto 80px;padding:0 16px}
    .panel{background:var(--panel);border:1px solid #1e2a52;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .camera,.preview{display:flex;align-items:center;justify-content:center;border:1px solid #212f60;border-radius:16px;min-height:240px;padding:8px;background:#0f1731}
    video{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:12px 0 8px}
    label{font-size:12px;color:var(--muted)}
    select,input[type="checkbox"],button{background:#091024;color:var(--text);border:1px solid #26335e;border-radius:12px;padding:10px 12px;font-size:14px}
    button{background:linear-gradient(180deg,#1a2a5a,#142149);border:1px solid #1c2f63;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .output{background:#0f1731;border:1px solid #212f60;border-radius:16px;padding:12px;min-height:120px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .row>*{flex:1}
    .progress{height:10px;background:#0b132a;border:1px solid #223164;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#46c6ff,#8ef9ff);transition:width .2s ease}
    .tiny{font-size:12px;color:var(--muted)}
    .routeCard{margin:14px 0;padding:14px;border-radius:16px;border:1px solid #1f2b55;background:#0e1733}
    .routeTop{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .routeTag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;margin-bottom:8px}
    .conf{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3c7a;background:#0d1c3a;color:#b9c8ff}
    .tag-re{background:rgba(110,231,255,.15);border:1px solid #2a9bb0;color:#a9f6ff}
    .tag-dpm{background:rgba(255,215,102,.15);border:1px solid #b79a2e;color:#ffeaa1}
    .tag-shc{background:rgba(40,224,185,.15);border:1px solid #1c9e84;color:#8af1df}
    .tag-review{background:rgba(255,122,122,.15);border:1px solid #a24444;color:#ffb3b3}
    .clues{margin-top:6px;color:#a9b3c3;font-size:12px}
    .actions{display:flex;gap:8px;margin-top:10px}
    .actions button{padding:6px 10px;font-size:12px}
    .threshold{margin-top:8px;font-size:12px;color:#a9b3c3}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>OCR Camera</h1>
    <div class="sub">One photo → one OCR job. Runs entirely on-device.</div>
    <div class="safety">This app runs locally in your browser. No files or text are uploaded or stored externally. Your data stays on this device.</div>
  </header>
  <div class="wrap">
    <div class="panel">
      <div id="route" class="routeCard" style="display:none">
        <div class="routeTop">
          <div id="routeTag" class="routeTag"></div>
          <div id="confBadge" class="conf" title="Confidence score based on routing clues"></div>
        </div>
        <div id="routeWhy" class="tiny"></div>
        <div id="routeClues" class="clues"></div>
        <div class="actions">
          <button id="forceDPM">Force DPM</button>
          <button id="forceRE">Force Real Estate</button>
          <button id="forceSHC">Force SHC</button>
          <button id="pickBtn">Use Photo</button>
          <input id="pick" type="file" accept="image/*" capture="environment" style="display:none" />
        </div>
        <div class="threshold">Review cutoff: <input id="cutoff" type="number" step="0.1" min="0" max="5" value="1.4" style="width:64px" /> (raise to be stricter) — <span id="camSelWrap"></span></div>
      </div>
      <div class="grid">
        <div>
          <div class="camera"><video id="video" playsinline autoplay muted></video></div>
          <div class="controls">
            <button id="startCam">Start Camera</button>
            <button id="flipCam">Flip</button>
            <button id="capture" disabled>Capture</button>
            <div>
              <label>Resolution</label><br/>
              <select id="res">
                <option value="hd">HD (1280×720)</option>
                <option value="fhd" selected>FHD (1920×1080)</option>
                <option value="uhd">UHD (3840×2160)</option>
              </select>
            </div>
          </div>
          <div class="controls">
            <div>
              <label>Language</label><br/>
              <select id="lang">
                <option value="eng" selected>English (eng)</option>
                <option value="spa">Spanish (spa)</option>
                <option value="fra">French (fra)</option>
                <option value="deu">German (deu)</option>
                <option value="por">Portuguese (por)</option>
                <option value="ita">Italian (ita)</option>
                <option value="nld">Dutch (nld)</option>
                <option value="jpn">Japanese (jpn)</option>
              </select>
            </div>
            <label><input type="checkbox" id="pre" checked /> Light clean‑up</label>
            <label><input type="checkbox" id="deskew" /> Try deskew</label>
            <button id="run" disabled>Run OCR</button>
            <button id="copy" disabled>Copy</button>
            <button id="download" disabled>Download .txt</button>
            <button id="downloadCsv" disabled>Download .csv</button>
          </div>
          <div class="row"><div class="progress"><div id="bar" class="bar"></div></div><div id="status" class="tiny muted">Idle</div></div>
        </div>
        <div class="preview" id="preview"><span class="muted">Capture to process one document at a time.</span></div>
      </div>
      <h3>Extracted Text</h3>
      <div id="out" class="output" spellcheck="false"></div>
      <p class="tiny">Tip: Fill the frame, avoid shadows, keep the phone parallel to the page.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
    }

    const video = document.getElementById('video');
    const startBtn = document.getElementById('startCam');
    const flipBtn = document.getElementById('flipCam');
    const capBtn = document.getElementById('capture');
    const pickBtn = document.getElementById('pickBtn');
    const pick = document.getElementById('pick');

    const preview = document.getElementById('preview');
    const runBtn = document.getElementById('run');
    const copyBtn = document.getElementById('copy');
    const dlBtn = document.getElementById('download');
    const csvBtn = document.getElementById('downloadCsv');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const out = document.getElementById('out');
    const resSel = document.getElementById('res');
    const cutoffInput = document.getElementById('cutoff');
    const camSelWrap = document.getElementById('camSelWrap');

    const routeCard = document.getElementById('route');
    const routeTag = document.getElementById('routeTag');
    const routeWhy = document.getElementById('routeWhy');
    const routeClues = document.getElementById('routeClues');
    const confBadge = document.getElementById('confBadge');
    const forceDPM = document.getElementById('forceDPM');
    const forceRE  = document.getElementById('forceRE');
    const forceSHC = document.getElementById('forceSHC');

    let stream = null; let facing = 'environment';
    let capturedImage = null; // canvas
    let isRunning = false; // enforce one-at-a-time
    let log = []; // CSV log
    let selectedDeviceId = null;

    function setStatus(msg){ statusEl.textContent = msg; }
    function setProgress(p){ bar.style.width = Math.min(100, Math.floor(p*100)) + '%'; }
    function resetUI(){ setProgress(0); setStatus('Idle'); out.textContent = ''; copyBtn.disabled = true; dlBtn.disabled = true; csvBtn.disabled = (log.length===0); runBtn.disabled = !capturedImage; hideRoute(); }

    function constraints(){
      let width=1920,height=1080;
      if(resSel.value==='hd'){ width=1280;height=720; }
      if(resSel.value==='uhd'){ width=3840;height=2160; }
      const base = { audio:false, video:{} };
      if (selectedDeviceId){
        base.video = { deviceId: { exact: selectedDeviceId }, width:{ideal:width}, height:{ideal:height} };
      } else {
        base.video = { facingMode: facing, width:{ideal:width}, height:{ideal:height} };
      }
      return base;
    }

    async function listCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        if(!cams.length) return;
        const sel = document.createElement('select');
        sel.id = 'camSel';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId;
          opt.textContent = c.label || ('Camera ' + (i+1));
          sel.appendChild(opt);
        });
        sel.addEventListener('change', ()=>{ selectedDeviceId = sel.value; startCamera(); });
        camSelWrap.innerHTML = 'Camera: ';
        camSelWrap.appendChild(sel);
        if(!selectedDeviceId && cams[0]) selectedDeviceId = cams[0].deviceId;
      }catch(e){ /* ignore */ }
    }

    async function startCamera(){
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); }
        const tries = [
          constraints(),
          { video: { facingMode: 'environment' }, audio:false },
          { video: true, audio:false }
        ];
        let lastErr = null;
        for (const c of tries){
          try{
            stream = await navigator.mediaDevices.getUserMedia(c);
            video.srcObject = stream;
            await video.play().catch(()=>{});
            capBtn.disabled = false; setStatus('Camera ready');
            return;
          }catch(e){ lastErr = e; }
        }
        throw lastErr || new Error('Camera not available');
      } catch(e){ console.error(e); setStatus('Camera error: ' + e.message + ' — use “Use Photo” to pick an image instead.'); }
    }

    startBtn.addEventListener('click', async ()=>{
      await listCameras();
      startCamera();
    });
    flipBtn.addEventListener('click', ()=>{ facing = (facing==='environment'?'user':'environment'); startCamera(); });

    capBtn.addEventListener('click', ()=>{
      if(!video.srcObject) return;
      const cnv = document.createElement('canvas');
      const vw = video.videoWidth || 1920, vh = video.videoHeight || 1080;
      cnv.width = vw; cnv.height = vh;
      const ctx = cnv.getContext('2d');
      ctx.drawImage(video, 0, 0, vw, vh);
      capturedImage = cnv; renderPreview(capturedImage);
      runBtn.disabled = false; setStatus('Captured. Ready to OCR');
    });

    pickBtn.addEventListener('click', ()=> pick.click());
    pick.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const img = new Image();
      img.onload = ()=>{
        const cnv = document.createElement('canvas');
        cnv.width = img.naturalWidth; cnv.height = img.naturalHeight;
        cnv.getContext('2d').drawImage(img,0,0);
        capturedImage = cnv; renderPreview(capturedImage);
        runBtn.disabled = false; setStatus('Photo loaded. Ready to OCR');
      };
      img.src = URL.createObjectURL(file);
    });

    function renderPreview(c){
      preview.innerHTML='';
      const disp=document.createElement('canvas');
      const scale=Math.min(1, (preview.clientWidth-16) / c.width);
      disp.width = Math.floor(c.width*scale); disp.height=Math.floor(c.height*scale);
      disp.getContext('2d').drawImage(c,0,0,disp.width,disp.height);
      preview.appendChild(disp);
    }

    function preprocess(img){
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
      canvas.width=img.width; canvas.height=img.height; ctx.drawImage(img,0,0);
      const imgData=ctx.getImageData(0,0,canvas.width,canvas.height); const data=imgData.data; let sum=0;
      for(let i=0;i<data.length;i+=4){ const g=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2]; data[i]=data[i+1]=data[i+2]=g; sum+=g; }
      const mean=sum/(data.length/4);
      for(let i=0;i<data.length;i+=4){ const v=data[i]>mean?255:0; data[i]=data[i+1]=data[i+2]=v; }
      ctx.putImageData(imgData,0,0); return canvas;
    }

    function deskewCanvas(cnv){
      return new Promise(async (resolve)=>{
        try{ const worker=await Tesseract.createWorker('eng'); const res=await worker.detect(cnv);
          const angle=((res&&res.data&&res.data.orientation&&res.data.orientation.deg)||0);
          await worker.terminate(); if(!angle) return resolve(cnv);
          const rotated=document.createElement('canvas'); const rad=angle*Math.PI/180; const s=Math.sin(rad), c=Math.cos(rad);
          const w=cnv.width,h=cnv.height; const newW=Math.abs(w*c)+Math.abs(h*s); const newH=Math.abs(w*s)+Math.abs(h*c);
          rotated.width=Math.ceil(newW); rotated.height=Math.ceil(newH); const rctx=rotated.getContext('2d');
          rctx.translate(newW/2,newH/2); rctx.rotate(rad); rctx.drawImage(cnv,-w/2,-h/2); resolve(rotated);
        }catch(e){ console.warn('deskew failed', e); resolve(cnv); }
      });
    }

    function showRoute(tag, why, clues, confidence){
      routeCard.style.display='block';
      routeTag.textContent=tag.label;
      routeWhy.textContent=why;
      routeClues.textContent = clues && clues.length ? "Matched clues: " + clues.join(', ') : "";
      routeTag.className = 'routeTag ' + tag.className;
      confBadge.textContent = 'Confidence: ' + Math.round(confidence * 100) / 100;
    }
    function hideRoute(){ routeCard.style.display='none'; }

    const RULES = {
      SHC: {
        label: 'ROUTE → SHC (MC 5536)', className:'tag-shc',
        clues: [
          { r: /\bstanford health care\b|\bshc\b/i, w: 2 },
          { r: /\bpasteur\b|\bwelch\b|\bblake\s*wilbur\b/i, w: 1.6 },
          { r: /\bp[-\s]?tube\b|\batrium\b|\bpacu\b|\bproton\b|\bradiology\b/i, w: 1.4 },
          { r: /\blucas\s*center\b|\bsom\s*(3t|7t)\b/i, w: 1.2 }
        ],
        why: 'Hospital/clinic terms or SHC-managed locations detected.'
      },
      DPM: {
        label: 'ROUTE → DPM (MC 7273)', className:'tag-dpm',
        clues: [
          { r: /\bconstruction\b|\bsite\s*work\b|\basphalt\b|\baggregates\b|\barc\s*flash\b|\brenovation\b|\bproject\s*(no\.?|number)\b/i, w: 1.5 },
          { r: /\b(jane\s*stanford\s*way|galvez|serra\s*(st|mall)|lomita\s*dr|panama\s*(st|mall)|campus\s*dr|via\s*ortega|via\s*pueblo|oak\s*rd|sam\s*mcdonald\s*mall|knight\s*way|nathan\s*abbott|thoburn\s*ct|angell\s*ct|churchill\s*mall|links\s*rd|pampas\s*ln|mayfield\s*ave)\b/i, w: 1.6 },
          { r: /\bAAAS\s*Commons\b|\bCorridor\s*Refresh\b|\bSecurity\s*System\s*Supply\b/i, w: 1.3 }
        ],
        why: 'Construction/trades context or on‑campus project locations detected.'
      },
      RE: {
        label: 'ROUTE → REAL ESTATE (MC 8873)', className:'tag-re',
        clues: [
          { r: /\b(sand\s*hill|porter|research\s*park|hillview|page\s*mill|el\s*camino\s*real|redwood\s*city|menlo\s*park|milpitas|san\s*jose|battery\s*st|willow\s*place|hansen\s*way|hanover\s*st|broadway)\b/i, w: 1.4 },
          { r: /\b(3450\s*hillview|2755\s*sand\s*hill|500\s*el\s*camino\s*real|1501\s*page\s*mill|2575\s*sand\s*hill|275\s*battery|2755\s*south\s*hillview|5215\s*hellyer|66\s*willow\s*place|295\s*page\s*mill|700\s*hansen\s*way|2825\s*sand\s*hill|275\s*s\.?\s*hillview|901\s*california\s*ave|2400\s*hanover|455\s*broadway)\b/i, w: 1.7 }
        ],
        why: 'Off‑campus or leased property keywords/addresses detected.'
      }
    };

    const EXCLUDE = {
      RE: [ /\bjane\s*stanford\s*way\b|\bgalvez\b|\bserra\b|\blomita\b|\bpanama\b|\bcampus\s*dr\b/i ],
      DPM: [ /\bmenlo\s*park\b|\bmilpitas\b|\bredwood\s*city\b|\bbattery\s*st\b|\bpage\s*mill\s*rd\b/i ]
    };

    function scoreRoute(text){
      const matches = { SHC: [], DPM: [], RE: [] };
      const scores = { SHC:0, DPM:0, RE:0 };
      for (const key of Object.keys(RULES)){
        for (const clue of RULES[key].clues){
          const m = text.match(clue.r);
          if (m){ scores[key] += clue.w; matches[key].push(m[0]); }
        }
      }
      if (EXCLUDE.RE.some(rx=>rx.test(text))) scores.RE -= 0.6;
      if (EXCLUDE.DPM.some(rx=>rx.test(text))) scores.DPM -= 0.6;
      const order = ['SHC','DPM','RE'];
      const best = order.reduce((a,k)=> scores[k] > scores[a] ? k : a, order[0]);
      const confidence = scores[best];
      return { best, scores, matches, confidence };
    }

    function classify(text, minConf){
      const t = (text||'').toLowerCase();
      const res = scoreRoute(t);
      const MIN_CONF = (typeof minConf==='number' ? minConf : 1.4);
      if (res.confidence < MIN_CONF){
        return { tag: { label:'REVIEW & SCAN → Upload to Preliminary Notices', className:'tag-review' }, why: 'Low confidence routing — no strong ownership clues.', clues: [], confidence: res.confidence };
      }
      const tag = RULES[res.best];
      const clues = res.matches[res.best];
      const why = tag.why;
      return { tag, why, clues, confidence: res.confidence };
    }

    async function runOCR(){
      if(isRunning) return; if(!capturedImage) return; isRunning=true;
      hideRoute();
      runBtn.disabled=true; capBtn.disabled=true; setStatus('Loading language…'); setProgress(0.02);
      let img=capturedImage;
      if(document.getElementById('pre').checked){ img=preprocess(capturedImage); renderPreview(img); }
      if(document.getElementById('deskew').checked){ setStatus('Checking orientation…'); img=await deskewCanvas(img); renderPreview(img); }
      try{
        const lang=document.getElementById('lang').value;
        const worker=await Tesseract.createWorker(lang, 1, { logger: m=>{ if(m.status) setStatus(m.status.replace(/_/g,' ')); if(m.progress!=null) setProgress(m.progress); } });
        const { data } = await worker.recognize(img);
        await worker.terminate();
        const text=(data&&data.text)?data.text.trim():''; out.textContent=text; copyBtn.disabled=!text.length; dlBtn.disabled=!text.length;
        const cutoff = parseFloat(cutoffInput.value||'1.4');
        const res = classify(text, cutoff);
        showRoute(res.tag, res.why, res.clues, res.confidence);
        const ts = new Date().toISOString();
        const snippet = (text||'').replace(/\n/g,' ').slice(0,200);
        const clues = (res.clues||[]).join('; ');
        log.push({ ts, route: res.tag.label, reason: res.why + (clues? ' | Clues: ' + clues : ''), conf: String(Math.round(res.confidence*100)/100), text: snippet });
        csvBtn.disabled = (log.length===0);
        setStatus('Done'); setProgress(1);
      } catch(e){ console.error(e); setStatus('Error – see console'); }
      finally{ isRunning=false; runBtn.disabled=false; capBtn.disabled=false; }
    }

    runBtn.addEventListener('click', runOCR);
    copyBtn.addEventListener('click', ()=>{ if(!out.textContent) return; navigator.clipboard.writeText(out.textContent); setStatus('Copied'); });
    dlBtn.addEventListener('click', ()=>{ if(!out.textContent) return; const blob=new Blob([out.textContent],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ocr.txt'; a.click(); URL.revokeObjectURL(a.href); });
    csvBtn.addEventListener('click', ()=>{
      let csv = 'Timestamp,Route,Reason,Confidence,Extracted Text\n';
      const esc = s => '"' + String(s || '').replace(/"/g,'""') + '"';
      log.forEach(r=>{ csv += [r.ts, r.route, esc(r.reason), r.conf, esc(r.text)].join(',') + '\n'; });
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ocr_log.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    if(navigator.permissions && navigator.permissions.query){
      navigator.permissions.query({name:'camera'}).then(p=>{ if(p.state==='granted') startCamera(); });
    }

    function showForced(tagKey){
      const tag = RULES[tagKey];
      showRoute(tag, '(Manual override)', [], 999);
      const ts = new Date().toISOString();
      log.push({ ts, route: tag.label, reason: '(Manual override)', conf: '999', text: (out.textContent||'').replace(/\n/g,' ').slice(0,200) });
      csvBtn.disabled = (log.length===0);
    }
    forceDPM.addEventListener('click', ()=>showForced('DPM'));
    forceRE.addEventListener('click', ()=>showForced('RE'));
    forceSHC.addEventListener('click', ()=>showForced('SHC'));
  </script>
</body>
</html>
